Authenticating with WHOOP (with Passport)
Though Javascript is a primary language for client-side application development, all requests to WHOOP must be made server-side. This tutorial does not propose or require a given framework for building Javascript server-side applications. Some examples of Javascript server-side frameworks are express.js and next.js.

You can choose from one of the many OAuth 2.0 libraries. In this tutorial, we will use Passport for authentication. Specifically, this will use the passport-oauth2 package.

Install Dependencies
npm install passport passport-oauth2

Additionally, if you're using Typescript, you'll want to include the type definitions as well:

npm install @types/passport @types/passport-oauth2

Configure The Strategy
We first need to define the data Passport will need to complete the OAuth 2.0 authorization flow, stored in a configuration.

const whoopOAuthConfig = {
    authorizationURL: `${process.env.WHOOP_API_HOSTNAME}/oauth/oauth2/auth`,
    tokenURL: `${process.env.WHOOP_API_HOSTNAME}/oauth/oauth2/token`,
    clientID: process.env.CLIENT_ID,
    clientSecret: process.env.CLIENT_SECRET,
    callbackURL: process.env.CALLBACK_URL,
    state: true,
    scope: [
        'offline',
        'read:profile'
    ],
}

The data elements are:

authorizationURL: The WHOOP URL prompts a user to sign in to WHOOP and authorize your application. Learn more
tokenURL: The WHOOP URL to exchange an authorization code for an access token. Learn more
clientID: A unique identifier for your client. Learn more
clientSecret: A secret value that accompanies your client identifier. Learn more
callbackURL: WHOOP will redirect the user to this location after the user authorizes your application. Learn more
state: Set this to true to have the strategy define the state value that WHOOP will pass back to your app. Learn more
scope: A list of the data types and operations your app can access. We are requesting the offline scope to retrieve a refresh token and read:profile to access User Profile information from the WHOOP API in this example. You need to add the relevant scopes your app needs access. Learn more
Determine What To Do After Authentication Succeeds
Passport needs a function to execute once the OAuth flow is complete. What occurs in that function is specific to your application.

In this example, we will use the received information from the OAuth flow to save the user to our database using Prisma. But, of course, what your application does with this may differ.

const getUser = async (
    accessToken,
    refreshToken,
    {expires_in},
    profile,
    done,
) => {
    const {first_name, last_name, user_id} = profile

    const createUserParams = {
        accessToken,
        expiresAt: Date.now() + expires_in * 1000,
        firstName: first_name,
        lastName: last_name,
        refreshToken,
        userId: user_id,
    }

    const user = await prisma.user.upsert({
        where: {userId: user_id},
        create: createUserParams,
        update: createUserParams,
    })

    done(null, user)
}

Passport will pass in several parameters that we can use in our application-specific logic:

accessToken: the access token to retrieve user information from the WHOOP API. For future requests, your app must pass the Access Token as a Bearer token in the Authorization header. We will use this as an example below to retrieve profile data.
refreshToken: Your app can use the Refresh Token to retrieve a new access token after expiration. Learn more
results: this is an object that contains fields for access_token, expires_in, scope, and token_type.
profile: the normalized representation of a user's profile data. The Passport library will populate the profile because we later tell Passport how to get user profile information.
done: a callback function accepting errors and the user as the parameters.
Given all that information, we are extracting the user's first name, last name, and WHOOP user id from their profile and storing that in our database, along with their active tokens.

Note that Passport's documentation shows a function that takes four parameters. Using this won't have the information about when the token expires, so we're instead, we're relying on a less-common variant for this data.

Get User Profile Information
WHOOP includes an API endpoint to access user profile details, which your app will have access to if the app requests (and the user authorizes) the read:profile scope.

const fetchProfile = async (
    accessToken,
    done,
) => {
    const profileResponse = await fetch(
        `${process.env.WHOOP_API_HOSTNAME}/developer/v1/user/profile/basic`,
        {
            headers: {
                Authorization: `Bearer ${accessToken}`,
            },
        },
    )

    const profile = await profileResponse.json()

    done(null, profile)
}

This async function uses Javascript's Fetch API to make a request to the WHOOP profile endpoint, passing in the access token we receive from a successful OAuth 2.0 flow as a bearer token in the Authorization header.

The function returns the user's profile information. Passport normalizes received profile information.

Use The WHOOP Strategy
Now that we have all of the individual pieces built, it's time to put them together.

const whoopAuthorizationStrategy = new OAuth2Strategy(whoopOAuthConfig, getUser)
whoopAuthorizationStrategy.userProfile = fetchProfile

passport.use('withWhoop', whoopAuthorizationStrategy)


Here we are building a strategy, passing it our WHOOP configuration and telling it what to do when a user is authenticated - which is to save or get the user from our database.

We're also telling the strategy to use our ability to fetch profile information.

Lastly, we're telling Passport itself to use our newly-created strategy.

Authenticate With WHOOP
We need to authenticate requests using passport.authenticate(). Where this gets invoked will depend on your framework of choice. Let's assume an Express application.

app.get('/auth/example',
    passport.authenticate('withWhoop'));

app.get('/auth/example/callback',
    passport.authenticate('withWhoop', {failureRedirect: '/login'}),
    function (req, res) {
        res.redirect('/welcome');
    });

How this gets invoked in your middleware stack or routing layer will depend on the framework you're using.

Congratulations
After going through this tutorial, you have learned:

How to build a custom Passport OAuth 2.0 strategy to complete the OAuth flow with WHOOP.
Where to add your custom logic to handle user management and persistence.
How to access a user's profile information and tell Passport about it to automatically retrieve user information from WHOOP.
How to connect those individual pieces with Passports OAuth 2.0 package.
The next step for you is to plug this into whatever framework or middleware you're using to trigger Passport to authenticate.

Previous
Tutorials
Refreshing Access Tokens
This example will use the Fetch API to make an HTTP request to WHOOP's server.

Prerequisites
Refresh Token: A refresh token is received along with an access token when completing the initial OAuth 2.0 flow, when the auth request includes the offline scope. Learn more
Client Id: A unique identifier for your client. Learn more
Client Secret: A secret value that accompanies your client identifier. Learn more
Refresh Token Endpoint: https://api.prod.whoop.com/oauth/oauth2/token . Learn more
Making the Request
We first need to assemble the parameters to provide to WHOOP's server in order to retrieve new access and refresh tokens.

const refreshParams = {
    grant_type: 'refresh_token',
    client_id: process.env.CLIENT_ID,
    client_secret: process.env.CLIENT_SECRET,
    scope: 'offline',
    refresh_token: refresh_token,
}

These fields represent:

grant_type: refresh_token. This grant type explicitly tells an OAuth provider you're asking for a refresh token.
client_id: A unique identifier for your client.
client_secret: A secret value that accompanies your client identifier.
scope: The offline scope allows your app the receive a refresh token, along with the new access token.
refresh_token: The value of the refresh token received along with an access token.
Now that we have the parameters to send to the API endpoint, we can construct the entire API call:

const getFreshTokens = async (refreshParams) => {
    const body = new URLSearchParams(refreshParams)
    const headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
    }

    const refreshTokenResponse = await fetch(
        `https://api.prod.whoop.com/oauth/oauth2/token`,
        {
            body,
            headers,
            method: 'POST',
        },
    )

    return refreshTokenResponse.json()
}

Response Type
The response object received from making the API request will look as follows:

interface AuthResult {
    access_token: string
    refresh_token: string
    expires_in: number
    scope: string
    token_type: 'bearer'
}

Congratulations
Your app can now use the new access token for subsequent API requests for this user's data. Your app can also use the refresh token to complete this flow once the access token expires.Authenticating with WHOOP
Postman is an application you can use to make, save, and share API requests. It includes the functionality to complete an OAuth 2.0 flow for user data. Being programming language-agnostic, it may be a great starting point to validate your credentials are functioning.

Environment Setup
The Postman collection used here requires that you set up the Client Secret information from the WHOOP Developer Dashboard, and you saved the data as Postman variables.

Create Environment Variables

In the Postman app, navigate to the "Environments" section on the far left. Then, add or modify two variables in the main content window:

ClientId - this is the unique client Id from the WHOOP Developer Dashboard.
ClientSecret - this is the secret for the client Id from the WHOOP Developer Dashboard.
In addition to naming these variables, fill in the values with the credentials from the Developer Dashboard.

Note: The screenshot does not show that information to avoid sharing credentials.

Now you're ready to use those values as variables for the rest of the flow, and don't need to share the actual secrets in the saved requests.

Starting the Authorization Flow
Postman includes support for completing the OAuth 2.0 flow. This section will show you how to give Postman access to your WHOOP credentials for future requests.

Navigate to the "Collections" section on the far left, and select the collection name for the WHOOP API in the pane to the right of that.

Next, select the "Authorization" heading in the main content window. It should be underlined in orange.

Postman Authorization

Fill in the fields as follows:

Type: OAuth 2.0
Add auth data to: Request Headers
Access Token: Available tokens
Header Prefix: Bearer
Grant Type: Authorization Code
Callback URL: check "Authorize using browser"
Auth URL: https://api.prod.whoop.com/oauth/oauth2/auth - Learn more.
Access Token URL: https://api.prod.whoop.com/oauth/oauth2/token - Learn more.
Client Id: {{ClientId}} - this is using the variable updated earlier. Learn more.
Client Secret: {{ClientSecret}} - this is using the variable updated earlier. Learn more.
Scope: A space-delimited list of scopes to request data access to. Learn more.
State: A string that must be at least eight characters long to be sent to the WHOOP server and used for verification. Learn more.
Client Authentication: Send client credentials in body
Lastly, click the "Get New Access Token" button, and Postman will make the request to WHOOP's Auth URL specified above.

Sign in to WHOOP
Postman should then redirect to a browser window and present WHOOP's sign-in form.

WHOOP Sign In

Fill in this information with the account information that Postman will use in future requests to access data.

Click the "SIGN IN" button after providing the account information.

Authorize Access to WHOOP Data
After providing valid WHOOP user account credentials, Postman will redirect you to a WHOOP log-in asking you to authorize your app and displays the requested scopes as part of the OAuth flow. These are all the scopes that were requested in Postman earlier.

WHOOP Data Authorization

To complete the flow, you must grant the application access by clicking the "GRANT" button.

Depending on your browser, you may receive an alert to redirect you back to the Postman app. Please do so to complete the round-trip.

Manage Access Tokens
After completing the redirect, Postman will next show a modal that displays all of the token information returned from WHOOP.

Manage WHOOP Tokens in Postman

Once again, this screenshot purposely censors the actual values of these tokens to not share personal information.

If you want to use the refresh_token in Postman to request a refreshed token, you will need to copy this value at this point and save it somewhere safe. Postman does not retain access to this data.

You will use the Access Token in future requests, and you can save those credentials in Postman.

Use Access Token
Click the "Use Token" button on the right in the Manage Access Tokens modal.

Use Token

For this to persist on future requests, that change must be saved by clicking the "Save" button on the far right of the collection after leaving the modal.

Save Collection

Congratulations
You have completed the OAuth 2.0 flow using Postman, and you can make additional requests for WHOOP data using this token in Postman.Refreshing Access Tokens
Postman is an application you can use to make, save, and share API requests. We're going to use it to demonstrate using a refresh token to receive a new access token from WHOOP.

Prerequisites
Refresh Token: A refresh token is received along with an access token when completing the initial OAuth 2.0 flow, when the auth request includes the offline scope. Learn more
Client Id: A unique identifier for your client. Learn more
Client Secret: A secret value that accompanies your client identifier. Learn more
Refresh Token Endpoint: https://api.prod.whoop.com/oauth/oauth2/token . Learn more
Making the Request
We're going to issue a POST request to the refresh token endpoint to receive a new access token.

Fill in the fields as follows:

HTTP Request Type/Verb: POST
URL: https://api.prod.whoop.com/oauth/oauth2/token
In the Body section, select the "x-www-form-urlencoded" radio button. Fill in the following keys and values:

grant_type: refresh_token. This grant type explicitly tells an OAuth provider you're asking for a refresh token.
refresh_token: The value of the refresh token received along with an access token.
client_id: A unique identifier for your client.
client_secret: A secret value that accompanies your client identifier.
scope: The offline scope allows you to get a new refresh token and an access token.
Postman Refresh Token Body

In this image, Postman variables take the place of the refresh token, client id, and client secret. Postman should prepopulate those variables with the configured values. Alternatively, place the values directly in the value of the POST data rather than using variables at all.

Click "Send" to make your request.

Receiving the Response
Under the Request Body section, a Response Body should be visible as a JSON payload. It will have the following form:

{
  "access_token": "the-value-of-the-new-access-token",
  "expires_in": 3600,
  "refresh_token": "the-value-of-the-new-refresh-token",
  "scope": "offline other-scopes-requested",
  "token_type": "bearer"
}

Congratulations
You can use the new access token to make additional API requests for this user's data. You can also use the new refresh token to complete this flow once the access token expires.

Previous
Authenticating with WHOOP
